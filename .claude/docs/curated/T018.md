# Curated References – T018 Outcome Flow Integration Test

## React Testing Library
- **Render + user interactions**: [`render`](https://testing-library.com/docs/react-testing-library/api/#render) renders components within JSDOM; `userEvent.setup()` produces realistic typing/click delays. Use `await user.click(...)` / `await user.type(...)` for async-safe actions.
- **Async assertions**: [`waitFor`](https://testing-library.com/docs/dom-testing-library/api-async/#waitfor) polls until callback stops throwing—ideal for modal open/close and banner refresh checks.
- **Querying text**: [`screen.getByRole`](https://testing-library.com/docs/queries/about/#priority) for accessible buttons (“Set Outcome Statement”, “Update Outcome”), `findByText` for async content (banner text).

## Vitest Utilities
- **Module mocking**: [`vi.mock`](https://vitest.dev/guide/mocking.html#vi-mock) replaces modules before import—use to stub `@supabase/supabase-js`, `sonner`, and `recomputeService`.
- **Spies & timers**: [`vi.fn`](https://vitest.dev/api/#vi-fn) for fetch/toast spies; [`vi.clearAllMocks`](https://vitest.dev/api/#vi-clearallmocks) between tests to prevent leakage.

## Next.js API Route Testing
- `NextResponse.json(body, { status })` (https://nextjs.org/docs/app/building-your-application/routing/router-handlers) returns a `Response` instance; tests can reuse handlers directly and treat them as fetch results (`response.ok`, `await response.json()`).
- Handlers accept native `Request` instances; create via `new Request('http://localhost/api/outcomes', init)` inside fetch stub for POST scenarios.

## Supabase Client Expectations
- Query builder chains: `.from('table').select('*').eq('field', value).maybeSingle()` should resolve to `{ data, error }`.
- Inserts commonly follow `.insert(payload).select().single()` and expect generated `id`, `created_at`, `updated_at`.
- Count queries: `.select('*', { count: 'exact', head: true }).eq('user_id', user)` should resolve to `{ count }` without data payload. Tailor in-memory mock accordingly.

## Outcome Domain Constraints
- Statement assembly: `assembleOutcome` (lib/services/outcomeService.ts) omits “the” for `launch`/`ship`, includes it otherwise—rely on this helper within test or Supabase mock to mirror backend behavior.
- Default user: API uses `DEFAULT_USER_ID = 'default-user'`; Supabase mock should enforce single active outcome per user to exercise replacement logic.
