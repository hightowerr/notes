# Code Review: T001 - Browser Storage Hooks

## Status
**FAIL**

## Summary
Implementation provides two custom React hooks for localStorage and sessionStorage persistence with SSR safety and error handling. While useLocalStorage meets all requirements, useSessionStorage is missing critical QuotaExceededError handling specified in the task requirements. Both hooks also have a stale closure issue that could cause race conditions and use inconsistent export patterns compared to the existing codebase.

---

## Issues Found

### CRITICAL

None

### HIGH

**File**: lib/hooks/useSessionStorage.ts
**Line**: 27-29
**Issue**: Missing QuotaExceededError handling in setValue function
**Requirement**: Task spec states "Same API as useLocalStorage" which includes graceful QuotaExceededError handling
**Fix**: Add the same error handling pattern from useLocalStorage.ts:
```typescript
} catch (error) {
  if (error instanceof DOMException && (error.name === 'QuotaExceededError' || error.name === 'NS_ERROR_DOM_QUOTA_REACHED')) {
    console.error(`SessionStorage quota exceeded for key "${key}"`);
  } else {
    console.error(error);
  }
}
```

### MEDIUM

**File**: lib/hooks/useLocalStorage.ts
**Line**: 34
**Issue**: Stale closure in setValue callback - `storedValue` dependency causes callback to capture stale value
**Impact**: When setValue is called multiple times quickly, the callback may use outdated storedValue when computing functional updates
**Fix**: Remove `storedValue` from dependency array and use functional form to access latest value:
```typescript
const setValue: SetValue<T> = useCallback((value) => {
  try {
    setStoredValue((currentValue) => {
      const valueToStore = value instanceof Function ? value(currentValue) : value;
      if (typeof window !== 'undefined') {
        window.localStorage.setItem(key, JSON.stringify(valueToStore));
      }
      return valueToStore;
    });
  } catch (error) {
    // ... error handling
  }
}, [key]); // Remove storedValue dependency
```

---

**File**: lib/hooks/useSessionStorage.ts
**Line**: 30
**Issue**: Same stale closure issue as useLocalStorage
**Fix**: Apply same pattern as described above for useLocalStorage

---

**File**: lib/hooks/useLocalStorage.ts
**Line**: 69
**Issue**: Uses `export default` instead of named export
**Impact**: Inconsistent with existing codebase pattern (see lib/hooks/useOutcomeDraft.ts:22, useReflectionShortcut.ts:12)
**Fix**: Change to named export:
```typescript
export function useLocalStorage<T>(...) { /* ... */ }
```

---

**File**: lib/hooks/useSessionStorage.ts
**Line**: 65
**Issue**: Uses `export default` instead of named export
**Impact**: Inconsistent with existing codebase pattern
**Fix**: Change to named export (same as above)

### LOW

None

---

## Standards Compliance

- [x] Tech stack patterns followed (React hooks pattern)
- [x] TypeScript strict mode clean (proper generics, type safety)
- [x] Files in scope only (two new files as specified)
- [ ] TDD workflow followed (no tests written - acceptable for SETUP task per tasks.md)
- [ ] Error handling proper (useSessionStorage missing quota handling)

## Implementation Quality

**Frontend**:
- [x] ShadCN CLI used (N/A - no UI components)
- [x] Accessibility WCAG 2.1 AA (N/A - utility hooks)
- [x] Responsive design (N/A - utility hooks)
- [x] Backend integration verified (N/A - client-side only)

**Code Quality**:
- [x] Clear, descriptive names
- [x] Single Responsibility Principle
- [ ] Proper error handling (incomplete in useSessionStorage)
- [x] Pure functions where possible
- [x] SSR safety implemented correctly
- [x] Storage event listeners for cross-tab sync (excellent addition)

## Vertical Slice Check

- [ ] User can SEE result (N/A - foundation SETUP task)
- [ ] User can DO action (N/A - foundation SETUP task)
- [ ] User can VERIFY outcome (Manual verification via DevTools specified in tasks.md)
- [x] Integration complete (Hooks ready for T002-T005 consumption)

**Note**: This is a [SETUP] task, not a [SLICE] task, so vertical slice requirements don't apply. The task correctly prepares foundation infrastructure for subsequent slices.

---

## Strengths

1. **Excellent SSR safety**: Both hooks properly check `typeof window === 'undefined'` in all critical paths
2. **Strong type safety**: Generic types properly constrained, clear type definitions for SetValue and RemoveValue
3. **Performance optimization**: Correct use of useCallback to prevent unnecessary re-renders
4. **Cross-tab synchronization**: Storage event listeners enable state sync across browser tabs (not in original spec but valuable addition)
5. **JSON serialization**: Proper JSON.parse/stringify with error handling
6. **useLocalStorage quota handling**: Correctly identifies both QuotaExceededError and NS_ERROR_DOM_QUOTA_REACHED (Firefox)
7. **Initial value fallback**: Gracefully degrades to in-memory state when storage unavailable
8. **Comprehensive error logging**: All catch blocks include console.error for debugging

---

## Recommendations

**Priority 1 (HIGH - Must fix before passing):**
1. Add QuotaExceededError handling to useSessionStorage.ts setValue function (lines 27-29)

**Priority 2 (MEDIUM - Should fix):**
2. Fix stale closure issue in both hooks by using functional setState pattern
3. Change both hooks to use named exports for consistency with existing codebase patterns

**Priority 3 (OPTIONAL - Nice to have):**
4. Consider adding JSDoc comments similar to useOutcomeDraft.ts:11-21 pattern for better IDE autocomplete
5. Add explicit return type annotations to the hook functions for documentation

---

## Next Steps

**If PASS**: Proceed to test-runner
**If FAIL**: Return to implementation with feedback

**Status**: FAIL

**Fixes Required**:
1. Add QuotaExceededError handling to useSessionStorage (HIGH)
2. Fix stale closure issues in both hooks (MEDIUM)
3. Change to named exports for consistency (MEDIUM)

---

## Test Validation Notes

Per tasks.md lines 78-96, this task uses **manual validation via DevTools** rather than automated tests. This is acceptable for foundation [SETUP] tasks.

**Manual Test Scenario** (from tasks.md):
```typescript
// Verify localStorage persistence
const [value, setValue] = useLocalStorage('trace-collapsed', false);
setValue(true);
// Check Application tab → localStorage shows 'trace-collapsed: true'
// Reload page → value persists

// Verify sessionStorage clears on tab close
const [seen, setSeen] = useSessionStorage('trace-first-visit', false);
setSeen(true);
// Check sessionStorage shows 'trace-first-visit: true'
// Close tab and reopen → sessionStorage cleared
```

**Recommendation**: After fixes, perform this manual test to verify:
1. Both hooks persist/retrieve values correctly
2. localStorage persists across page reloads
3. sessionStorage clears on tab close
4. QuotaExceededError is caught and logged gracefully (simulate by filling storage)
5. SSR safety works (test in Next.js server component context if possible)
